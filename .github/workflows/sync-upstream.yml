name: Sync with Upstream Releases

on:
  # Run daily at 00:00 UTC to check for new releases
  schedule:
    - cron: '0 0 * * *'
  # Allow manual triggering
  workflow_dispatch:

jobs:
  sync:
    name: Sync with ethereum/go-ethereum
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          BOT_EMAIL="41898282+github-actions[bot]"
          BOT_EMAIL="${BOT_EMAIL}@users.noreply.github.com"
          git config user.email "$BOT_EMAIL"

      - name: Add upstream remote
        run: |
          # Add upstream remote if it doesn't exist
          git remote add upstream \
            https://github.com/ethereum/go-ethereum.git || true
          git fetch upstream --tags

      - name: Get latest upstream release
        id: get_release
        run: |
          # Get the latest release tag from upstream
          LATEST_TAG=$(git -c 'versionsort.suffix=-' \
            ls-remote --tags --refs --sort='v:refname' upstream | \
            tail -n1 | sed 's/.*\///')
          echo "Latest upstream release: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

          # Check if this tag already exists locally
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            echo "Tag $LATEST_TAG already exists locally"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          else
            echo "New release detected: $LATEST_TAG"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream release
        if: steps.get_release.outputs.needs_update == 'true'
        run: |
          LATEST_TAG="${{ steps.get_release.outputs.latest_tag }}"
          echo "Merging upstream release: $LATEST_TAG"

          # Try to merge the upstream tag
          MERGE_MSG="Merge upstream release $LATEST_TAG"
          if git merge "$LATEST_TAG" --no-edit -m "$MERGE_MSG"; then
            echo "Successfully merged $LATEST_TAG"
            echo "merge_status=success" >> $GITHUB_ENV
          else
            echo "Merge conflict detected for $LATEST_TAG"
            echo "merge_status=conflict" >> $GITHUB_ENV
            git merge --abort
          fi

      - name: Push changes
        if: |
          steps.get_release.outputs.needs_update == 'true' &&
          env.merge_status == 'success'
        run: |
          git push origin ${{ github.ref_name }}
          echo "Successfully pushed merged changes"

      - name: Create Issue for Merge Conflict
        if: |
          steps.get_release.outputs.needs_update == 'true' &&
          env.merge_status == 'conflict'
        uses: actions/github-script@v7
        with:
          script: |
            const latestTag =
              '${{ steps.get_release.outputs.latest_tag }}';
            const title =
              `Merge conflict with upstream release ${latestTag}`;
            const upstreamUrl =
              'https://github.com/ethereum/go-ethereum';
            const body = `A new release \`${latestTag}\` was detected \
            from the upstream repository (ethereum/go-ethereum), but \
            automatic merging failed due to conflicts.

            Please manually merge the upstream changes:
            \`\`\`bash
            git remote add upstream ${upstreamUrl}.git
            git fetch upstream --tags
            git merge ${latestTag}
            # Resolve conflicts
            git commit
            git push
            \`\`\`

            Upstream release: ${upstreamUrl}/releases/tag/${latestTag}`;

            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'upstream-sync'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['upstream-sync', 'merge-conflict']
              });
              console.log('Created issue for merge conflict');
            } else {
              console.log('Issue already exists for this release');
            }

      - name: Summary
        if: always()
        run: |
          echo "## Upstream Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          LATEST="${{ steps.get_release.outputs.latest_tag }}"
          NEEDS_UPDATE="${{ steps.get_release.outputs.needs_update }}"
          echo "- Latest upstream release: $LATEST" \
            >> $GITHUB_STEP_SUMMARY
          echo "- Update needed: $NEEDS_UPDATE" \
            >> $GITHUB_STEP_SUMMARY
          if [ "$NEEDS_UPDATE" = "true" ]; then
            echo "- Merge status: ${merge_status:-pending}" \
              >> $GITHUB_STEP_SUMMARY
          fi
