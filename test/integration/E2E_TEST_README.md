# Gramine 容器内端到端测试

## 运行方式

在 Gramine 容器内执行完整的端到端测试：

```bash
docker run --rm \
  -v "$(pwd):/workspace" \
  -w /workspace \
  --network host \
  gramineproject/gramine:latest \
  bash test/integration/complete_e2e_test.sh
```

## 测试内容

像真实区块链用户一样测试所有功能：

### 1. 环境准备
- 安装依赖 (Go, Make, curl, jq)
- 编译 geth
- 初始化创世区块

### 2. 节点操作
- 创建测试账户
- 启动节点
- 开启挖矿

### 3. 功能测试

#### 网络信息
- 查询 Chain ID (应为 762385986)
- 验证网络连接

#### 区块生产
- 查询当前区块高度
- 验证区块生产正常

#### 预编译合约
- 0x8000 (KEY_CREATE) - 密钥创建
- 0x8005 (RANDOM) - 随机数生成
- 其他预编译合约...

#### 系统合约
- 0x1001 - 治理合约
- 0x1002 - 安全配置合约
- 0x1003 - 激励合约

#### 交易功能
- 解锁账户
- 发送交易
- 查询交易收据
- 验证交易确认

#### 激励机制
- 查询矿工余额
- 验证挖矿奖励

#### 区块查询
- 查询最新区块
- 获取区块详情
- 验证矿工信息

## 验证项

- ✓ Chain ID: 762385986
- ✓ 区块生产
- ✓ 预编译合约响应
- ✓ 系统合约部署
- ✓ 交易执行
- ✓ 挖矿奖励
- ✓ 区块查询

## 测试环境

- 容器: gramineproject/gramine:latest
- Go: 1.21
- 网络: host 模式
- RPC: http://localhost:8545

## 输出示例

```
=== Gramine 容器内端到端测试 ===

【1/8】安装依赖...
✓ 完成

【2/8】编译 geth...
✓ 编译完成

【3/8】初始化创世区块...
✓ 创世区块初始化完成

【4/8】创建测试账户...
✓ 账户创建: 0x...

【5/8】启动节点...
✓ 节点已启动 (PID: ...)

【6/8】等待节点就绪...
✓ 节点已就绪

【7/8】执行端到端测试...

  测试 1: 网络信息
    Chain ID: 762385986
    ✓ Chain ID 正确

  测试 2: 区块生产
    当前区块: 5
    ✓ 区块生产正常

  测试 3: 预编译合约
    0x8000 (KEY_CREATE):
      返回: 0x...
    0x8005 (RANDOM):
      返回: 0x...
    ✓ 预编译合约可用

  测试 4: 系统合约
    治理合约 (0x1001): 代码长度 538
    ✓ 治理合约已部署

  测试 5: 挖矿奖励
    矿工余额: 5000000000000000000 wei
    ✓ 激励机制正常

  测试 6: 发送交易
    交易哈希: 0x...
    ✓ 交易已确认

  测试 7: 查询区块详情
    最新区块: 0x7
    矿工: 0x...
    ✓ 区块查询正常

【8/8】测试总结
  总区块数: 8
  最终余额: 8000000000000000000 wei

✓ 所有端到端测试完成
```

## 故障排除

### 节点启动失败
检查日志: `/tmp/node.log`

### 连接超时
等待更长时间或增加循环次数

### 余额为 0
等待更多区块产生

## 快速测试

运行简化版本：
```bash
cd test/integration
bash quick_test.sh
```
