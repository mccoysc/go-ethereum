# X Chain 模块开发文档

本目录包含 X Chain 各模块的开发文档，用于指导不同开发团队进行并行开发。

## 项目概述

X Chain 是基于 go-ethereum 的区块链，使用 Intel SGX 远程证明替代传统的 PoS 共识机制。所有验证节点运行在 SGX enclave 中，通过远程证明确保代码完整性和执行环境安全。

## 模块列表

| 模块 | 文档 | 负责团队 | 预计工时 |
|------|------|----------|----------|
| SGX 证明模块 | [01-sgx-attestation.md](01-sgx-attestation.md) | 安全/密码学团队 | 2 周 |
| 共识引擎模块 | [02-consensus-engine.md](02-consensus-engine.md) | 核心协议团队 | 3 周 |
| 激励机制模块 | [03-incentive-mechanism.md](03-incentive-mechanism.md) | 经济模型团队 | 2.5 周 |
| 预编译合约模块 | [04-precompiled-contracts.md](04-precompiled-contracts.md) | 智能合约团队 | 3 周 |
| 治理模块 | [05-governance.md](05-governance.md) | 治理/协议团队 | 3 周 |
| 数据存储与同步模块 | [06-data-storage-sync.md](06-data-storage-sync.md) | 存储/基础设施团队 | 2.5 周 |
| Gramine 集成模块 | [07-gramine-integration.md](07-gramine-integration.md) | DevOps/基础设施团队 | 3 周 |

## 模块依赖关系

```
                    +-------------------+
                    |  Gramine 集成模块 |
                    +-------------------+
                            |
        +-------------------+-------------------+
        |                   |                   |
        v                   v                   v
+---------------+   +---------------+   +------------------+
| SGX 证明模块  |   | 数据存储模块  |   |    治理模块      |
+---------------+   +---------------+   +------------------+
        |                   |                   |
        +-------------------+-------------------+
                            |
                            v
                    +---------------+
                    | 共识引擎模块  |
                    +---------------+
                            |
        +-------------------+-------------------+
        |                                       |
        v                                       v
+---------------+                       +---------------+
| 激励机制模块  |                       | 预编译合约模块|
+---------------+                       +---------------+
```

### 依赖说明

**SGX 证明模块** 是基础模块，提供远程证明和 RA-TLS 功能，被其他所有模块依赖。

**共识引擎模块** 依赖 SGX 证明模块进行出块者身份验证，是区块链核心逻辑。

**激励机制模块** 依赖共识引擎模块的出块事件，计算和分发奖励。

**预编译合约模块** 依赖共识引擎模块的状态管理，提供密钥管理功能。

**治理模块** 依赖 SGX 证明模块进行节点准入控制，管理度量值白名单和验证者。

**数据存储与同步模块** 依赖 SGX 证明模块进行安全数据传输，管理加密存储和参数校验。

**Gramine 集成模块** 是部署层，配置 SGX 运行环境，被所有模块依赖。

## 开发顺序建议

基于模块依赖关系，建议按以下顺序开发：

**第一阶段（基础设施）**
1. Gramine 集成模块 - 搭建 SGX 运行环境
2. SGX 证明模块 - 实现远程证明基础功能

**第二阶段（核心功能）**
3. 数据存储与同步模块 - 实现加密存储和参数校验
4. 共识引擎模块 - 实现 PoA-SGX 共识

**第三阶段（扩展功能）**
5. 治理模块 - 实现白名单管理和验证者治理
6. 预编译合约模块 - 实现密钥管理预编译合约
7. 激励机制模块 - 实现奖励计算和分发

## 安全参数架构

X Chain 的安全参数采用**链上合约存储 + Manifest 固定合约地址**的架构：

### 合约职责划分

| 合约 | 职责 |
|------|------|
| **安全配置合约（SecurityConfigContract）** | 存储所有安全配置，被其他模块读取 |
| **治理合约（GovernanceContract）** | 负责投票、管理投票人（有效性、合法性）、把投票结果写入安全配置合约 |

### Manifest 固定参数

这些参数在 Docker 镜像构建时嵌入 Gramine manifest，影响 MRENCLAVE 度量值：

| 参数 | 说明 |
|------|------|
| `XCHAIN_ENCRYPTED_PATH` | 加密分区路径 |
| `XCHAIN_SECRET_PATH` | 秘密数据路径 |
| `XCHAIN_GOVERNANCE_CONTRACT` | 治理合约地址（写死，作为安全锚点） |
| `XCHAIN_SECURITY_CONFIG_CONTRACT` | 安全配置合约地址（写死，作为安全锚点） |

**重要说明**：合约地址写死在 Manifest 中，影响 MRENCLAVE，攻击者无法修改合约地址而不改变度量值。

### 链上安全参数（从 SecurityConfigContract 读取）

所有安全、准入、秘密数据管理策略等相关配置都从安全配置合约动态读取：

| 参数 | 说明 |
|------|------|
| MRENCLAVE 白名单 | 允许的 enclave 代码度量值 |
| MRSIGNER 白名单 | 允许的签名者度量值 |
| 密钥迁移阈值 | 密钥迁移所需的最小节点数 |
| 节点准入策略 | 是否严格验证 Quote |
| 分叉配置 | 硬分叉升级相关配置 |
| 数据迁移策略 | 加密数据迁移相关配置 |

### 运行时参数（命令行控制）

这些参数可在容器启动时通过命令行灵活配置：

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--xchain.block.interval` | 出块间隔（秒） | 15 |
| `--xchain.block.max-tx` | 每块最大交易数 | 1000 |
| `--xchain.block.max-gas` | 每块最大 Gas | 30000000 |
| `--xchain.rpc.port` | RPC 端口 | 8545 |
| `--xchain.p2p.port` | P2P 端口 | 30303 |
| `--xchain.log.level` | 日志级别 | info |

### 参数校验机制

启动时的参数处理流程：
1. 首先读取 Manifest 中的固定参数（本地路径 + 合约地址）
2. 从链上安全配置合约读取安全参数
3. 读取用户命令行参数
4. 合并参数：Manifest 参数覆盖用户参数
5. 如果用户参数与 Manifest 不一致，提示并退出进程

详见 [数据存储与同步模块](06-data-storage-sync.md) 中的参数校验机制。

## 网络引导机制（Bootstrap）

X Chain 的安全参数从链上合约读取，但首次运行时还没有链。解决方案是**创世区块预部署合约**：

1. 治理合约和安全配置合约在创世区块中预部署
2. 合约地址是确定性的（基于部署者地址和 nonce），可以预先计算
3. Manifest 中写死这个预计算的合约地址
4. 引导阶段：前 N 个（如 5 个）运行正确 MRENCLAVE 的节点自动成为创始管理者
5. 正常阶段：新管理者必须通过现有管理者投票添加

详见 [治理模块](05-governance.md) 中的网络引导机制。

## 测试策略

每个模块文档都包含单元测试示例。测试应遵循以下原则：

**单元测试**：测试单个函数或方法的正确性，使用 mock 隔离外部依赖。

**集成测试**：测试模块间的交互，需要 SGX 模拟环境或真实硬件。

**安全测试**：测试侧信道防护、参数校验、权限控制等安全功能。

## 代码规范

**Go 代码规范**
- 使用 `gofmt` 格式化代码
- 使用 `golint` 检查代码风格
- 所有导出的函数和类型必须有文档注释
- 错误处理使用 `fmt.Errorf` 包装上下文信息

**安全编码规范**
- 敏感数据使用后必须清零
- 使用常量时间比较防止时序攻击
- 私钥必须存储在加密分区
- 不在日志中输出敏感信息

## 相关文档

- [ARCHITECTURE.md](../../ARCHITECTURE.md) - 完整架构设计文档
- [go-ethereum 文档](https://geth.ethereum.org/docs) - 以太坊客户端文档
- [Gramine 文档](https://gramine.readthedocs.io/) - Gramine LibOS 文档
- [Intel SGX 文档](https://www.intel.com/content/www/us/en/developer/tools/software-guard-extensions/overview.html) - Intel SGX 开发文档
